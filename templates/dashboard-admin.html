<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            background-color: #f8f9fa;
        }
        
        .card {
            border-radius: 10px;
        }
        
        .table-container {
            margin-top: 30px;
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Dashboard</h1>
            <a href="{% url 'logout' %}" class="btn btn-outline-danger">Logout</a>
        </div>
        <!-- Dashboard Stats -->
        <div class="row text-center">
            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Total Registered Artists</h5>
                        <h3 class="text-primary" id="total-artists">{{ total_artists }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Active Artists</h5>
                        <h3 class="text-success" id="active-artists">{{ active_artists }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Disabled Artists</h5>
                        <h3 class="text-danger" id="disabled-artists">{{ disabled_artists }}</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-md-6 offset-md-3">
                <form method="get" action="{% url 'dashboard' %}">
                    <div class="input-group">
                        <input type="text" name="search" class="form-control" placeholder="Search artists by name..." value="{{ query }}">
                        <button class="btn btn-primary" type="submit">Search</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Artist Table -->
        <div class="table-container">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Artist Details</h5>
                </div>
                <div class="card-body">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr id="artist-row-{{ artist.id }}">
                                <th>S.No</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Contact Number</th>
                                <th>State</th>
                                <th>Date of Registration</th>
                                <th>Profile Picture</th>
                                <th>Active Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dynamic Data Rows -->
                            {% if page_obj %}
                            {% for artist in page_obj %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ artist.name }}</td>
                                <td>{{ artist.email }}</td>
                                <td>{{ artist.contact_number }}</td>
                                <td>
                                    {% if artist.additional_info.all %}
                                        {% for additional in artist.additional_info.all %}
                                            {{ additional.state }} 
                                        {% endfor %}
                                    {% else %}
                                        <span>No state information</span>
                                    {% endif %}
                                </td>
                                <td>{{ artist.date_of_registration|date:"d-m-Y" }}</td>
                                <td>
                                    {% if artist.additional_info.all %}
                                        {% for additional in artist.additional_info.all %}
                                            {% if additional.profile_picture %}
                                            <a href="{{ additional.profile_picture.url }}" target="_blank">
                                                <img src="{{ additional.profile_picture.url }}" alt="Profile Picture" style="width: 50px; height: 50px; object-fit: cover;">
                                            </a>
                                            {% else %}
                                                <span>No picture</span>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <span>No profile picture</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input toggle-status" type="checkbox" id="status-{{ artist.id }}" {% if artist.is_active %}checked{% endif %} data-id="{{ artist.id }}">
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-danger btn-sm delete-artist" data-id="{{ artist.id }}">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                            {% endfor %} 
                            {% else %}
                            <tr>
                                <td colspan="8" class="text-center">No records found</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                    <!-- Pagination Links -->
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}&search={{ query }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% endif %} {% for num in page_obj.paginator.page_range %}
                            <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                                <a class="page-link" href="?page={{ num }}&search={{ query }}">{{ num }}</a>
                            </li>
                            {% endfor %} {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}&search={{ query }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
<!-- Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Delete Artist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this artist and all their related data?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Example: Attach event listeners for toggle switches and delete buttons
            document.querySelectorAll(".toggle-status").forEach((switchElement) => {
                switchElement.addEventListener("change", function() {
                    const artistId = this.dataset.id;
                    const isActive = this.checked;
                    console.log(`Artist ID: ${artistId}, Active Status: ${isActive}`);
                    fetch("{% url 'update_artist_status' %}", {
                        method: "POST",
                        body: JSON.stringify({
                            artist_id: artistId,
                            is_active: isActive,
                        }),
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.success) {
                                // Update the counts dynamically
                                document.getElementById("active-artists").textContent = data.active_artists;
                                document.getElementById("disabled-artists").textContent = data.disabled_artists;
                            } else {
                                alert(data.message);
                            }
                        })
                        .catch((error) => {
                            console.error("Error updating status:", error);
                            alert("An error occurred while updating the artist status.");
                        });
                });
                            
            });

        });
        document.addEventListener("DOMContentLoaded", function() {
            let artistIdToDelete = null; // Variable to store artist ID for deletion
        
            // Event listener for delete buttons
            document.querySelectorAll(".delete-artist").forEach((deleteButton) => {
                deleteButton.addEventListener("click", function() {
                    artistIdToDelete = this.dataset.id; // Get the artist ID
                    // Show the confirmation modal
                    $('#deleteConfirmationModal').modal('show');
                });
            });
        
            // Event listener for the confirm delete button in the modal
            document.getElementById("confirmDelete").addEventListener("click", function() {
                if (artistIdToDelete) {
                    // Send an AJAX request to delete the artist and their related data
                    fetch("{% url 'delete_artist' %}", {
                        method: "POST",
                        body: JSON.stringify({
                            artist_id: artistIdToDelete
                        })
                    })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            // Hide the modal and remove the row from the table
                            $('#deleteConfirmationModal').modal('hide');
                          //  document.querySelector(`#artist-row-${artistIdToDelete}`).remove();
                            
                            alert("Artist deleted successfully!");
                            location.reload();

                        } else {
                            alert("Error deleting artist: " + data.message);
                        }
                    })
                    .catch((error) => {
                        console.error("Error deleting artist:", error);
                        alert("An error occurred while deleting the artist.");
                    });
                }
            });
        });
        
    </script>
</body>

</html>